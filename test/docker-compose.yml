version: "2.4"

services:
    proxy:
        restart: unless-stopped
        build: ../
        ports:
            - "${HTTP_PORT}:80"
            - "${HTTPS_PORT}:443"
        environment:
            TZ: GMT
            REWRITE_11: 'web1 bew1\.example\.com'
            REWRITE_12: 'web1 bew[a-z]+\.example\.com'
            REWRITE_13: 'http://web1 bew\.example\..*'
            REWRITE_14: 'web1:80 bew\w+\.example\..*'
            REWRITE_50: "websocketecho\tws.*"
            REWRITE_90: "web1"
            REWRITE_92: "%1 directhost-([^:]+)"
            REWRITE_100: "fallback fall back"
            REWRITE_8000: "fallback z.*"
            REWRITE_9001: "fallback .*"
            SERVER_INFO_ENDPOINT: "/.server/info"
            SERVER_STATUS_ENDPOINT: "/.server_status"
            ENABLE_JSON_LOG: 1
            ENABLE_HTTP2: 1
        volumes:
            - "../rootfs/etc/apache2/httpd.conf:/etc/apache2/httpd.conf"
            - "../rootfs/var/www/ssl:/var/www/ssl"
            - "../rootfs/docker-entrypoint.sh:/docker-entrypoint.sh"
            - "./.htaccess:/var/www/proxy/.htaccess"
        extra_hosts:
            - "host.docker.internal:host-gateway"
    web1:
        image: nginxdemos/hello:plain-text
        hostname: "web-1"
    web2:
        image: nginxdemos/hello:plain-text
        hostname: "web-2"
    web3:
        image: nginxdemos/hello:plain-text
        hostname: "web-3"
    fallback:
        image: nginxdemos/hello:plain-text
        hostname: "fallback"
    websocketecho:
        image: jmalloc/echo-server
        hostname: "ws-server"
        environment:
            PORT: 80
